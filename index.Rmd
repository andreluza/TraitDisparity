---
title: "Supplementary material, Bridging macroecology and macroevolution in the radiation of sigmodontine rodents"
author: "-"
date: "December 02, 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Appendix S2

#### Results using the complete sample of 100 fully resolved phylogenies from Upham et al. (2019). We show results using the set of 216 species with occurrence, trait and phylogenetic data. Then we show results using data of species of the clade Oryzomyalia.

In this document, we report supplementary results regarding other analytically viable options that could be used in our manuscript. The figures and tables follow the same order and setting as the ones presented in the main text:  

1 - The table with GLM coefficients showing differences in the slope of SES disparity ~ SES MPD between empirical and simulated disparity. Similar to Table 1. 

2 -  The relationship between SES MPD (Mean Pairwise (phylogenetic) Distance between species) and SES disparity produced by the empirical data set of skull morphology, and three data sets generated by trait simulation (Brownian motion[BM], Early-Burst[EB], and Ornstein-Uhlenbeck [OU]). Similar to Fig. 2 in the main text.

3 - A panel of five maps of A) empirical morphological disparity, B) disparity compared to a null model, C) disparity compared to a BM evolutionary model, D) significance of the map B, E) significance of the map C. Similar to Fig. 3 in the main text.

4 - A panel comprising four maps, showing the disparity expected by i) a null model, ii) BM model, iii) EB model, iv) OU model. Similar to Fig. 4 in the main text. We show the correlation between these expectations as a separate table after the map.    
  

First of all we show the table of averaged GLM coefficients that considers phylogenetic uncertainty when testing which simulated disparity gets closer to the empirical disparity (results alternative to Table 1 in the main text). The GLM estimates were averaged (and its standard deviation calculated) across 100 runs in each one of the 100 fully resolved phylogenies. As reported in the main text, we found that disparity simulated by the EB model gets closer to the empirical disparity, with a very subtle difference (~0.02) in slope relative to the empirical disparity (Table S2.1). 


Table S2.1: Averaged GLM estimates, obtained by averaging estimates produced by each one of the 100 different phylogenies used to simulate traits and calculate disparity. Results produced by the data set of 413 species.

```{r, echo = F, fig.height=6.5,fig.width=6.5,fig.margin=F, message=F, warning=F,fig.show="hide"}

source ("./R/Interpretation_Fig2_and_statistics_413spp.R")

 (list.mean)

```
Table S2.2: Standard deviation of GLM estimates, obtained by calculating the standard deviation of estimates produced by each one of the 100 different phylogenies used to simulate traits and calculate disparity. Results produced by the data set of 413 species.
```{r, echo = F, fig.height=6.5,fig.width=6.5,fig.margin=F, message=F, warning=F}

list.sd

```


### Analysis with 216 species, and considering phylogenetic uncertainty
Using this subset of the data, we produced a bivariate plot describing the relationship between SES disparity and SES MPD, for the empirical and simulated data sets. We found that this relationship was similar to the one reported in the main results (Fig. 2 in the main text). Overall, the disparity produced by the EB model had a closer relationship with the empirical disparity than had the other models of evolution (OU and BM). However, phylogenetic uncertainty (as shown by the boxplots) was much higher here --mainly for EB -- than when simulating traits using the phylogeny with 413 species.


```{r, echo = F, fig.height=6.5,fig.width=6.5,fig.align= "center",fig.margin=F, message=F, warning=F}

source ("./R_uncertainty_S2/Interpretation_Fig2_and_statistics_216spp.R")

# run this to get the panel with the relationship between MPD and DISPARITY
# and other results

```
Fig. S2.1. Bivariate plot showing the relationship between SES MPD and SES disparity, for empirical and simulated disparity. Results produced by the data set of 216 species.


As presented in the results (mapping section), we counted the number of cells with values of disparity higher, equal, or lower than the null model (including randomization, NULL) and the BM model. We again found a high number of cells with values of disparity lower than expected by the null model, and none cell had values higher than that. A total of 134 cells had disparity lower than expected by the BM model, and 12 had disparity higher than that.  



```{r pressure, echo=FALSE}

# the number of cells with  empirical disparity either higher or lower than
# the null/evol model disparity
# (significance in terms of to have values more extreme than 1.96)

count_cells_relative_to_models


```


When mapping the values of empirical and simulated trait values, we found a high agreement between the following maps and the ones shown in Fig. 3 of main text. However, less cells had a disparity higher than expected by the BM model in the Atlantic Rainforest.


```{r, echo = F, fig.height=10,fig.width=5,fig.margin=T,fig.align="center", message=F, warning=F}

source ("./R_uncertainty_S2/Interpretation_Fig3_216spp.R")

# run this to get the panel with the relationship between MPD and DISPARITY
# and other results


```
Fig. S2.2. Map of empirical (A), null (random shuffling of species in trait matrix) (B) and simulated disparity (using the BM model) (C). In D we show the significance of SES values presented in B, and in E we show the significance of SES values presented in C. Results produced by the data set of 216 species.  
  

Finally, we show the maps of null and simulated disparity. We found that using a null model is quite similar to simulating a trait using the OU model. This can be seen in the following map, where the null disparity and the disparity produced by the OU model produced quite similar, highly correlated maps (0.98, Table below the map). The correlation was also high  between  Null and BM disparity.


```{r, echo = F, fig.height=7,fig.width=6.5,fig.align= "center",fig.margin=F, message=F, warning=F}


alternative_map1


```
Fig. S2.3. Map of null (random shuffling of species in trait matrix) and simulated disparity values (using the BM, OU and EB models of evolution). The legend is common to all maps. Results produced by the data set of 216 species.  



Table of correlation between these estimates


```{r , echo=FALSE}

## show the correlation between average null and simulated by OU

cor (data.frame (RAO_OBS$med_nulo, obsBM,obsEB,obsOU))


```




### Results for clade Oryzomyalia, considering phylogenetic uncertainty

Bivariate plot similar to Fig. 2. This is pretty similar to the results reported in the main text, and alternative results considering 216 species (just presented). However, the main difference is that we lost values of SES MPD higher than zero, as now we lost phylogenetic distances by working within Oryzomyalia.



```{r, echo = F, fig.height=6.5,fig.width=6.5,fig.align= "center",fig.margin=F, message=F, warning=F}

source ("./R_uncertainty_S2/Interpretation_Fig2_and_statistics_Oryzomyalia.R")

# run this to get the panel with the relationship between MPD and DISPARITY
# and other results

```
Fig. S2.4. Bivariate plot showing the relationship between SES MPD and SES disparity, for empirical and simulated disparity. Results produced by the data set of Oryzomyalia species.


Counting the number of cells. Again, much more cells having disparity lower than the null model than the other models. However, we did not find any cell with values of disparity higher than the BM model.



```{r , echo=FALSE}

# the number of cells with  empirical disparity either higher or lower than
# the null/evol model disparity
# (significance in terms of to have values more extreme than 1.96)

count_cells_relative_to_models


```



The maps of observed and simulated disparity still resemble the ones shown in Fig. 3 (main text), and the ones just reported considering 216 species. However, now we did not find a higher disparity than expected by the BM model along the Atlantic Rainforest. 




```{r, echo = F, fig.height=10,fig.width=5,fig.align= "center",fig.margin=T,fig.align="center",  message=F, warning=F}

source ("./R_uncertainty_S2/Interpretation_Fig3_Oryzomyalia.R")


# run this to get the panel with the relationship between MPD and DISPARITY
# and other results

```
Fig. S2.5. Map of empirical (A), null (random shuffling of species in trait matrix) (B) and simulated disparity (using the BM model) (C). In D we show the significance of SES values presented in B, and in E we show the significance of SES values presented in C. Results produced by the data set of Oryzomyalia species.  


Finally, we report high correlation between null and simulated disparity (map similar to Fig. 4, and Fig. S2.3 presented above).



```{r, echo = F, fig.height=7,fig.width=6.5,fig.align= "center",fig.margin=F, message=F, warning=F}


alternative_map1


```
Fig. S2.6. Map of null (random shuffling of species in trait matrix) and simulated disparity values (using the BM, OU and EB models of evolution). The legend is common to all maps. Results produced by the data set of Oryzomyalia species.  



Correlations between maps were similar to the ones reported in the main text and in the previous analyses (high correlation between NULL and BM- and OU-simulated disparity.



```{r , echo=FALSE}

## show the correlation between average null and simulated by OU

cor (data.frame (RAO_OBS$med_nulo, obsBM,obsEB,obsOU))


```





### Appendix S3 

#### Results considering the consensus phylogeny. As it has 285 tips, the number of species used in trait simulations was 285 (for trait simulated with all tips), 169 (all species with occurrence, trait and phylogenetic data) and 159 species (belonging to the clade Oryzomyalia). By using the consensus tree we assume it is the TRUE phylogeny, which may not apply (especially for these rodents).  


The figures we will present now have the same settings and order as the ones we presented above.
Bivariate plot similar to Fig. 2. The EB-resulting disparity is still closer to the empirical disparity than other models.  



```{r, echo = F, fig.height=4,fig.width=4,fig.align= "center",fig.margin=F, message=F, warning=F}

source ("./R_concensus_supp_S3/Interpretation_Fig2_and_statistics_413spp.R")

# run this to get the panel with the relationship between MPD and DISPARITY

figure1
# and other results

```

Fig. S3.1. Bivariate plot showing the relationship between SES MPD and SES disparity, for empirical and simulated disparity. Results produced by the data set of 285 species and the consensus tree.  

  
  
Counting the number of cells. Again we found a large number of cells with disparity higher than the null disparity. However, we did not find any cell with disparity lower than BM. We also did not find any cell with disparity higher than BM.  



```{r , echo=FALSE}

# the number of cells with  empirical disparity either higher or lower than
# the null/evol model disparity
# (significance in terms of to have values more extreme than 1.96)

count_cells_relative_to_models


```



Maps similar to Fig. 3, and to maps just reported considering the subsets of the data (Fig. S2.2 and S2.5). The maps still resemble, but now we did not find cells with disparity higher or lower than expected by BM model.



```{r, echo = F, fig.height=10,fig.width=5,fig.align= "center",fig.margin=T,fig.align="center",  message=F, warning=F}

source ("./R_concensus_supp_S3/Interpretation_Fig3_413spp.R")

# run this to get the panel with the relationship between MPD and DISPARITY
# and other results

```
Fig. S3.2. Map of empirical (A), null (random shuffling of species in trait matrix) (B) and simulated disparity (using the BM model) (C). In D we show the significance of SES values presented in B, and in E we show the significance of SES values presented in C. Results produced by the data set of 285 species and the consensus tree.    

  
Using the consensus phylogeny, we found variation relative to results presented above and in the main text. The maps of BM- and OU-simulated disparity showed higher spatial variation than reported previously. 


```{r, echo = F, fig.height=7,fig.width=6.5,fig.align= "center",fig.margin=F, message=F, warning=F}


alternative_map1


```
Fig. S3.3. Map of null (random shuffling of species in trait matrix) and simulated disparity values (using the BM, OU and EB models of evolution). The legend is common to all maps. Results produced by the data set of 285 species and the consensus tree.    
  
    
The correlation between null disparity and simulated disparity was moderate to low. The highest correlation we found was between OU- and EB-simulated disparity (0.38). The correlation between null disparity and OU disparity was 0.19.



```{r , echo=FALSE}

## show the correlation between average null and simulated by OU

cor (data.frame (RAO_OBS$med_nulo, obsBM,obsEB,obsOU))


```


These results mostly repeat considering 169 species with occurrence, trait and phylogenetic data.
  

```{r, echo = F, fig.height=4,fig.width=4,fig.align= "center",fig.margin=F, message=F, warning=F}

source ("./R_concensus_supp_S3/Interpretation_Fig2_and_statistics_216spp.R")

# run this to get the panel with the relationship between MPD and DISPARITY

figure1
# and other results

```

Fig. S3.4. Bivariate plot showing the relationship between SES MPD and SES disparity, for empirical and simulated disparity. Results produced by the data set of 169 species and the consensus tree.  
  

Counting the number of cells. Now we found again some cells with disparity lower than BM, but none higher than BM.



```{r , echo=FALSE}

# the number of cells with  empirical disparity either higher or lower than
# the null/evol model disparity
# (significance in terms of to have values more extreme than 1.96)

count_cells_relative_to_models


```


Map similar to the Fig. S3.2. Again, no cell had a higher disparity than the BM model.


```{r, echo = F, fig.height=10,fig.width=5,fig.align= "center",fig.margin=T,fig.align="center",  message=F, warning=F}

source ("./R_concensus_supp_S3/Interpretation_Fig3_216spp.R")

# run this to get the panel with the relationship between MPD and DISPARITY
# and other results

```
Fig. S3.5. Map of empirical (A), null (random shuffling of species in trait matrix) (B) and simulated disparity (using the BM model) (C). In D we show the significance of SES values presented in B, and in E we show the significance of SES values presented in C. Results produced by the data set of 169 species and the consensus tree.  
  
  
The map of null and simulated disparity is similar to the one reported in Fig. S3.3 (i.e., the maps of BM- and OU-simulated disparity showed higher spatial variation than reported previously).


```{r, echo = F, fig.height=7,fig.width=6.5,fig.align= "center",fig.margin=F, message=F, warning=F}


alternative_map1


```
Fig. S3.6. Map of null (random shuffling of species in trait matrix) and simulated disparity values (using the BM, OU and EB models of evolution). The legend is common to all maps. Results produced by the data set of 169 species and the consensus tree.  

  
The correlation between null and simulated values were now higher than the ones just reported, with the higher correlation being between NULL and BM (0.56) and between NULL and OU (0.52).


```{r , echo=FALSE}

## show the correlation between average null and simulated by OU

cor (data.frame (RAO_OBS$med_nulo, obsBM,obsEB,obsOU))


```



The analysis of the Oryzomyalia data set, considering the consensus phylogeny, produced results that were more congruent to the  ones reported in this Appendix.



```{r, echo = F, fig.height=4,fig.width=4,fig.align= "center",fig.margin=F, message=F, warning=F}

source ("./R_concensus_supp_S3/Interpretation_Fig2_and_statistics_Oryzomyalia.R")

# run this to get the panel with the relationship between MPD and DISPARITY

figure1
# and other results

```
Fig. S3.7. Bivariate plot showing the relationship between SES MPD and SES disparity, for empirical and simulated disparity. Results produced by the data set of Oryzomyalia species (159 species) and the consensus tree.  

  

Counting the number of cells. We found again a large number of cells with disparity higher than the BM model.



```{r , echo=FALSE}

# the number of cells with  empirical disparity either higher or lower than
# the null/evol model disparity
# (significance in terms of to have values more extreme than 1.96)

count_cells_relative_to_models


```



These cells were mainly disposed along the Atlantic Rainforest region (supporting the findings of the main text) (Fig. 3).



```{r, echo = F, fig.height=10,fig.width=5,fig.align= "center",fig.margin=T,fig.align="center", message=F, warning=F,results="hide"}

source ("./R_concensus_supp_S3/Interpretation_Fig3_Oryzomyalia.R")

# run this to get the panel with the relationship between MPD and DISPARITY
# and other results

```
Fig. S3.8. Map of empirical (A), null (random shuffling of species in trait matrix) (B) and simulated disparity (using the BM model) (C). In D we show the significance of SES values presented in B, and in E we show the significance of SES values presented in C. Results produced by the data set of Oryzomyalia species (159 species) and the consensus tree.  
  

  

We found large spatial variation in disparity produced by BM and OU, and moderate correlation between NULL and EB (0.56), NULL and OU (0.51), and disparity produced by EB and OU (0.58).



```{r, echo = F, fig.height=7,fig.width=6.5,fig.align= "center",fig.margin=F, message=F, warning=F}


alternative_map1


```
Fig. S3.9. Map of null (random shuffling of species in trait matrix) and simulated disparity values (using the BM, OU and EB models of evolution). The legend is common to all maps. Results produced by the data set of Oryzomyalia species (159 species) and the consensus tree.  

  
And also correlations.


```{r , echo=FALSE}

## show the correlation between average null and simulated by OU

cor (data.frame (RAO_OBS$med_nulo, obsBM,obsEB,obsOU))


```


### Appendix S4: Sensitivity of results to model parameters


Finally, we report results regarding different values of model parameters used in trait simulations.


To understand whether results were sensitive to different values of model parameters (basically sigma for BM, sigma and beta for EB, and sigma and alpha for OU), we ran a sensitivity analysis showing how the regression coefficient of SES disparity ~ SES MPD relationship would change by using trait simulations ran with different model parameters. 
We then simulated trait data using the following values:
  sigma: 0.5, 1.0, 1.5, 2.0 (weak to strong rate of random fluctuations)
  beta: -0.5,  0.0,  0.5,  1.0 (early to late burst)
  alpha: 1.0 1.5 2.0 2.5 (weak to strong attraction to an average trait value)*

In the main text we showed the similarity of SES disparity ~SES MPD relationship between empirical and simulated disparity (BM-, EB- and OU-simulated disparity) (Fig. 2 in the main). Here, we did the same analysis, but now considering this range of values of sigma, beta, and alpha. Remember that in the main text we used: sigma = 1, beta = -0.5, and alpha = 1. We ran the sensitivity analysis using the consensus phylogeny to save processing time.

We found that empirical SES disparity ~ SES MPD relationship was quite similar to simulated SES disparity ~ SES MPD across the alternative values of sigma (Fig. S4.1). The slopes of simulated SES disparity ~ SES MPD were less steeper than the slope produced by empirical SES disparity ~ SES MPD, as reported in the main results.

We found that the empirical SES disparity ~ SES MPD relationship was quite similar to the simulated SES disparity ~ SES MPD across the alternative values of beta (Fig. S4.1, middle) -- except to a late-burst model with beta = 1. SES disparity calculated using traits simulated with values of beta = -0.5 and 0 produced a slope of simulated SES disparity ~ SES MPD that is very close to the slope of empirical SES disparity ~ SES MPD.

Different values of alpha produced very contrasting simulated SES disparity ~ SES MPD relationships-- i.e., from positive to neutral and negative slopes (Fig. S4.1, bottom). Disregarding the value of alpha, all the relationships shown for different alphas were quite different from the empirical SES disparity ~ SES MPD relationship reported in the main text.

Finally, neither BM nor OU (and alternative values of sigma and alpha) produced a simulated SES disparity ~ SES MPD as closer to the empirical SES disparity ~ SES MPD as the EB model (as found in the main results). 



```{r, echo = F, fig.height=6.5,fig.width=6.5,fig.align= "center",fig.margin=F, message=F, warning=F,results="hide"}

source ("./R_sensitivity_supp_S4/Interpretation_Fig2_and_statistics_413spp.R")

# run this to get the panel with the relationship between MPD and DISPARITY

panel
# and other results

```
Fig. S4.1. Sensitivity analysis regarding different values of parameters of BM (sigma, top), EB (sigma and beta, middle), and OU (sigma and alpha, bottom) models of evolution used to trait simulations. The EB and OU also have a sigma parameter, which was set to 1. To improve visualization we produced different plots for empirical and simulated data.
  
    

### Appendix S5: Sensitivity of results to model parameters estimated from data

We ran sensitivity analyses of our results to the use of parameter estimates that are more fitted (optimal) to empirical trait data. This is an alternative approach to a prior definition of values of sigma, beta and alpha in the different evolutionary models. We estimated parameter values using the function mvgls of mvMORPH package of R which is able to deal with large trait data. We used data  for 216 species with occurrence, trait, and phylogenetic data (the consensus phylogeny). However, we were only able to estimate parameters for the BM model (in the case the sigma) using the complete set of 112 skull landmarks. We could not estimate parameters for EB and OU models as they are very computationally intensive to handle. For instance, we tried to run the mvgls model for EB and OU with 10 iterations in a notebook with 16GB RAM. Using these settings the function required additional 8GB RAM and then crashed. Thus, we show here only results considering the mvgls estimates of sigma and compared the trait disparity produced by this model with empirical and null disparity in produced by data (Figs. S5.1 and S5.2).


```{r, echo = F, fig.height=4,fig.width=4,fig.margin=F, fig.align= "center", message=F, warning=F,results="hide"}

source ("./R_concensus_supp_S5/Interpretation_Fig2_and_statistics_216spp.R")

# run this to get the panel with the relationship between MPD and DISPARITY

hist_sigma 


```
Fig. S5.1. Histogram of the values of Sigma estimated by the Generalized Least Squares model to multivariate (high-dimensional) data sets (mvgls). Plotted values are the sample estimates (object S of mvgls function of R) The vertical dotted line indicates the average sigma across the 112 simulated traits.   
  
  
  
Estimated values of sigma ranged from `r min(simul_params_BM$sigma$S)` to `r max(simul_params_BM$sigma$S)`, with an average +- standard deviation of `r mean(simul_params_BM$sigma$S)` +- `r sd(simul_params_BM$sigma$S)` (Fig. S5.1).  


We found that the disparity produced by the BM model closely resembles the disparity found in the empirical data set. The resemblance we found here was much higher than the one found in the main results (where we simulate univariate traits and compared with a N-dimensional empirical data set). Finally, the null model (which in our main results was quite similar to an OU model with a single optimum) is unlikely to reproduce disparity found in the empirical trait data set (Fig. S5.2).
    
  
```{r, echo = F, fig.height=5,fig.width=6,fig.margin=F,  fig.align= "center", message=F, warning=F,results="hide"}

# run this to get the panel with the relationship between MPD and DISPARITY

figure1 


```
Fig. S5.1. Bivariate plot showing the relationship between SES MPD and SES disparity, for empirical (gray), simulated disparity (blue), and null disparity (orange). Simulated disparity was produced by simulating the same number of traits found in the empirical data set (112 landmarks) under a BM model; simulations of such amount of traits was not feasible using EB and OU models. Null disparity waas produced by shuffling species identities in the trait data set.  




